# 端口收紧方案 - 快速参考

> 📅 生成时间：2025-11-07  
> 🎯 目标：将开放端口从全开放收紧到仅保留必需端口

---

## 🔥 核心要点

### ✅ 必须开放的端口（共4个）

| 端口 | 服务 | 适用节点 | 说明 |
|-----|------|---------|------|
| **80** | Nginx Ingress HTTP | 231, 234, 235 | **Dify应用主入口** |
| **443** | Nginx Ingress HTTPS | 231, 234, 235 | HTTPS加密访问 |
| **19530** | Milvus向量数据库 | 231 | **知识库核心** |
| **30100** | Loki日志API | 231, 234, 235 | 日志收集（建议保留） |

### ⚙️ 运维管理端口（建议限制IP）

| 端口 | 服务 | 适用节点 | 建议 |
|-----|------|---------|------|
| **30718** | K8s Dashboard | 231, 234, 235 | 限制运维IP访问 |
| **30300** | Grafana | 231, 234, 235 | 限制运维IP访问 |
| **9091** | Milvus Web UI | 231 | 可选（限制IP或关闭） |

### ⛔ 必须关闭的端口（安全风险）

| 端口 | 服务 | 说明 |
|-----|------|------|
| 6443 | K8s API Server | 仅允许内网192.168.44.0/24 |
| 2379-2380 | etcd集群 | 仅允许3个节点互访 |
| 10250 | kubelet | 仅允许内网 |
| 22 | SSH | 仅允许运维堡垒机 |

---

## 🚀 快速部署方案

### 方案一：使用 iptables（推荐）

#### 三台服务器通用规则（231, 234, 235）

```bash
#!/bin/bash
# 清理旧规则（谨慎操作！）
# iptables -F

# 1. 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 2. 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 3. 允许内网互访（集群通信）
iptables -A INPUT -s 192.168.44.0/24 -j ACCEPT

# 4. 开放核心服务端口（对外网）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT       # HTTP
iptables -A INPUT -p tcp --dport 443 -j ACCEPT      # HTTPS
iptables -A INPUT -p tcp --dport 30100 -j ACCEPT    # Loki

# 5. 限制运维端口（替换为实际运维IP）
ADMIN_IP="<运维IP段，如 10.0.0.0/24>"
iptables -A INPUT -p tcp --dport 30718 -s $ADMIN_IP -j ACCEPT  # Dashboard
iptables -A INPUT -p tcp --dport 30300 -s $ADMIN_IP -j ACCEPT  # Grafana
iptables -A INPUT -p tcp --dport 22 -s $ADMIN_IP -j ACCEPT     # SSH

# 6. 拒绝其他所有入站流量
iptables -A INPUT -j DROP

# 保存规则（Ubuntu/Debian）
apt-get install -y iptables-persistent
netfilter-persistent save
```

#### 主节点额外规则（仅 192.168.44.231）

```bash
# 开放 Milvus 向量库
iptables -I INPUT 5 -p tcp --dport 19530 -j ACCEPT

# Milvus Web UI（可选）
ADMIN_IP="<运维IP段>"
iptables -I INPUT 6 -p tcp --dport 9091 -s $ADMIN_IP -j ACCEPT

# 保存规则
netfilter-persistent save
```

---

### 方案二：使用云安全组（阿里云/腾讯云）

如果服务器在云平台上，**强烈建议使用云安全组**，更安全且易管理。

#### 入站规则配置

| 优先级 | 端口范围 | 协议 | 来源 | 说明 |
|-------|---------|------|------|------|
| 1 | 80 | TCP | 0.0.0.0/0 | HTTP（所有节点） |
| 2 | 443 | TCP | 0.0.0.0/0 | HTTPS（所有节点） |
| 3 | 19530 | TCP | 0.0.0.0/0 | Milvus（仅231） |
| 4 | 30100 | TCP | 0.0.0.0/0 | Loki（所有节点） |
| 5 | 30718 | TCP | <运维IP> | Dashboard（所有节点） |
| 6 | 30300 | TCP | <运维IP> | Grafana（所有节点） |
| 7 | 22 | TCP | <堡垒机IP> | SSH（所有节点） |
| 8 | 6443 | TCP | 192.168.44.0/24 | K8s API（所有节点） |
| 9 | 2379-2380 | TCP | 192.168.44.0/24 | etcd（所有节点） |
| 10 | 10250 | TCP | 192.168.44.0/24 | kubelet（所有节点） |

---

## 📊 端口使用清单

### 节点1：192.168.44.231（主节点 - 32C/128G）

#### 对外开放
| 端口 | 服务 | 访问限制 |
|-----|------|---------|
| 80 | Ingress HTTP | 🌐 公网 |
| 443 | Ingress HTTPS | 🌐 公网 |
| 19530 | Milvus | 🌐 公网 |
| 30100 | Loki | 🌐 公网 |
| 30300 | Grafana | 🔒 运维IP |
| 30718 | Dashboard | 🔒 运维IP |
| 9091 | Milvus UI | 🔒 运维IP（可选） |
| 22 | SSH | 🔒 堡垒机 |

#### 内网限制
| 端口 | 服务 | 访问限制 |
|-----|------|---------|
| 6443 | K8s API | 🏠 内网 192.168.44.0/24 |
| 2379-2380 | etcd | 🏠 内网 192.168.44.0/24 |
| 10250 | kubelet | 🏠 内网 192.168.44.0/24 |

---

### 节点2 & 节点3：192.168.44.234、235（标准节点 - 16C/32G）

#### 对外开放
| 端口 | 服务 | 访问限制 |
|-----|------|---------|
| 80 | Ingress HTTP | 🌐 公网 |
| 443 | Ingress HTTPS | 🌐 公网 |
| 30100 | Loki | 🌐 公网 |
| 30300 | Grafana | 🔒 运维IP |
| 30718 | Dashboard | 🔒 运维IP |
| 22 | SSH | 🔒 堡垒机 |

#### 内网限制
| 端口 | 服务 | 访问限制 |
|-----|------|---------|
| 6443 | K8s API | 🏠 内网 192.168.44.0/24 |
| 2379-2380 | etcd | 🏠 内网 192.168.44.0/24 |
| 10250 | kubelet | 🏠 内网 192.168.44.0/24 |

---

## 🧪 验证测试

### 1. 测试核心服务可用性

```bash
# 测试 Dify 应用（HTTP）
curl -I http://192.168.44.231

# 测试 Ingress HTTPS
curl -k -I https://192.168.44.231

# 测试 Milvus 连接
nc -zv 192.168.44.231 19530

# 测试 Loki API
curl http://192.168.44.231:30100/ready
```

### 2. 测试运维端口限制

```bash
# 从运维机器测试（应该成功）
curl -k https://192.168.44.231:30718

# 从外部测试（应该被拒绝）
curl --connect-timeout 5 https://192.168.44.231:30718
# 预期：连接超时或被拒绝
```

### 3. 扫描开放端口

```bash
# 从外网扫描（安全验证）
nmap -Pn -p 1-65535 192.168.44.231

# 预期结果：只显示80、443、19530、30100等允许的端口
```

---

## ⚠️ 实施注意事项

### 🚨 风险警告

1. **防止锁定**：确保SSH端口（22）规则正确，避免失去访问权限
2. **测试连接**：每添加一条规则后，立即测试服务可用性
3. **备份规则**：执行前备份当前iptables规则
   ```bash
   iptables-save > /root/iptables-backup-$(date +%F).rules
   ```

### 📝 实施步骤

1. **准备阶段**（30分钟）
   - 备份当前配置
   - 确认所有服务正常运行
   - 准备回滚方案

2. **灰度测试**（1小时）
   - 先在节点3（235）上测试规则
   - 验证服务可用性
   - 监控应用日志

3. **全量上线**（30分钟）
   - 在节点2（234）上应用规则
   - 最后在主节点（231）上应用规则
   - 全量验证

4. **监控观察**（24小时）
   - 监控 Grafana 面板
   - 检查应用错误日志
   - 验证用户访问正常

---

## 🔍 常见问题

### Q1: Dify 应用无法访问？
**检查**：
```bash
# 确认Ingress端口开放
iptables -L INPUT -n | grep "dpt:80\|dpt:443"

# 确认Ingress服务正常
kubectl get svc -n ingress-nginx
```

### Q2: Dashboard 无法访问？
**检查**：
```bash
# 确认来源IP是否在白名单
iptables -L INPUT -n --line-numbers | grep 30718

# 如果需要临时开放
iptables -I INPUT 1 -p tcp --dport 30718 -j ACCEPT
```

### Q3: 知识库功能异常？
**检查**：
```bash
# 确认 Milvus 端口开放（主节点）
nc -zv 192.168.44.231 19530

# 检查 Milvus 容器状态
docker ps | grep milvus
```

### Q4: 如何快速回滚？
```bash
# 恢复备份规则
iptables-restore < /root/iptables-backup-<日期>.rules

# 或清空所有规则（风险高！）
iptables -F
iptables -P INPUT ACCEPT
```

---

## 📞 支持联系

- **紧急回滚命令**：`iptables -F && iptables -P INPUT ACCEPT`
- **查看当前规则**：`iptables -L -n -v --line-numbers`
- **服务状态检查**：`kubectl get pods -A | grep -v Running`

---

**文档版本**: v1.0  
**最后更新**: 2025-11-07  
**维护者**: 运维团队





