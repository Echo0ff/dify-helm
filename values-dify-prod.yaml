# ============================================
# Dify Helm Chart - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®
# ============================================
# è¯´æ˜ï¼š
# - æœ¬æ–‡ä»¶åŒ…å«ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–é…ç½®
# - åŸºäº values-dify.yamlï¼Œé’ˆå¯¹é«˜ RPS å’Œé«˜å¯ç”¨åœºæ™¯ä¼˜åŒ–
# - é…åˆ values-secrets.yaml ä½¿ç”¨
#
# é›†ç¾¤é…ç½®ï¼ˆ3èŠ‚ç‚¹ HA é›†ç¾¤ï¼‰: 
#   - Node 1: 32C/128G (high-performance) - é«˜æ€§èƒ½èŠ‚ç‚¹ï¼ŒAPI/Worker ä¼˜å…ˆè°ƒåº¦
#   - Node 2: 16C/32G (standard) - æ ‡å‡†èŠ‚ç‚¹ï¼Œå‡è¡¡è°ƒåº¦
#   - Node 3: 16C/32G (standard) - æ ‡å‡†èŠ‚ç‚¹ï¼Œå‡è¡¡è°ƒåº¦
#
# ä¼˜åŒ–ç›®æ ‡ï¼š
#   - é«˜å¹¶å‘ï¼šæ”¯æŒ 400+ RPS
#   - é«˜å¯ç”¨ï¼š3 èŠ‚ç‚¹ HAï¼ŒPod åˆ†æ•£è°ƒåº¦
#   - èµ„æºä¼˜åŒ–ï¼šåˆç†çš„ requests/limitsï¼Œé¿å… OOM
#   - è¿æ¥æ± ä¼˜åŒ–ï¼šGunicorn + SQLAlchemy + Redis è¿æ¥æ± è°ƒä¼˜
#
# éƒ¨ç½²å‘½ä»¤ï¼š
# helm upgrade dify ./charts/dify -n dify \
#   -f values-dify.yaml \
#   -f values-secrets.yaml \
#   -f values-dify-prod.yaml
# ============================================

###################################
# API æœåŠ¡ä¼˜åŒ–ï¼ˆæœ€å…³é”®ï¼‰
###################################
api:
  enabled: true
  # åˆå§‹å‰¯æœ¬æ•°ï¼š6 ä¸ªï¼ˆå¢åŠ APIå¤„ç†èƒ½åŠ›ï¼Œä¸»è¦å¤„ç†å·¥ä½œæµ/å¯¹è¯æµï¼‰
  replicas: 9
  
  # âš ï¸ å¤–éƒ¨è®¿é—®URLé…ç½®ï¼ˆè§£å†³å·¥ä½œæµå‘å¸ƒURLé—®é¢˜ï¼‰
  # åªé…ç½®å·¥ä½œæµå‘å¸ƒéœ€è¦çš„URLï¼Œå…¶ä»–ä¿æŒé»˜è®¤ï¼ˆä½¿ç”¨same domainï¼‰
  url:
    # åº”ç”¨Web URLï¼ˆâš ï¸ å…³é”®ï¼šå·¥ä½œæµå‘å¸ƒæ—¶ä½¿ç”¨æ­¤URLï¼‰
    # ä¿®å¤ä» http://dify-ups/workflow/xxx åˆ°æ­£ç¡®çš„å¤–éƒ¨åœ°å€
    appWeb: "http://47.97.245.112"
    files: "http://47.97.245.112"
  
  # èµ„æºé…ç½®ï¼šæé«˜å•Podèµ„æºï¼Œå‡å°‘è¶…æ—¶é”™è¯¯
  resources:
    requests:
      cpu: "2000m"      # æé«˜åˆ° 2 æ ¸ï¼ˆç¡®ä¿å……è¶³å¤„ç†èƒ½åŠ›ï¼‰
      memory: "4Gi"     # æé«˜åˆ° 4Gï¼ˆé¿å…å†…å­˜å‹åŠ›ï¼‰
    limits:
      cpu: "6000m"      # æœ€å¤š 6 æ ¸
      memory: "6Gi"     # æœ€å¤š 6Gï¼ˆç»™äºˆå……è¶³ä¸Šé™ï¼‰

  # è‡ªå®šä¹‰ prompts
  persistence:
    enabled: true
    volumes:
      - name: custom-prompts
        configMap:
          name: dify-prompts
    volumeMounts:
      - name: custom-prompts
        mountPath: /app/api/core/llm_generator/prompts.py
        subPath: prompts.py
        readOnly: true
  
  # å¯ç”¨æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼ˆHPAï¼‰- é’ˆå¯¹å¯¹è¯æµä¼˜åŒ–
  autoscaling:
    enabled: true
    minReplicas: 9            # æé«˜æœ€å°å‰¯æœ¬æ•°ï¼ˆä¼˜å…ˆä¿è¯APIèƒ½åŠ›ï¼‰
    maxReplicas: 12           # æœ€å¤š 10 ä¸ªï¼ˆå……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼‰
    targetCPUUtilizationPercentage: 60    # 60% æ‰©å®¹ï¼ˆæ›´æ—©å“åº”è´Ÿè½½ï¼‰
    targetMemoryUtilizationPercentage: 65 # 65% æ‰©å®¹ï¼ˆé¿å…å†…å­˜ç“¶é¢ˆï¼‰
  
  # ä¼˜åŒ–å¥åº·æ£€æŸ¥ - æ›´å®½å®¹çš„é…ç½®ï¼Œå‡å°‘çŠ¶æ€é”™è¯¯
  livenessProbe:
    enabled: true
    initialDelaySeconds: 45     # å¢åŠ åˆå§‹å»¶è¿Ÿï¼Œç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
    periodSeconds: 30           # é™ä½æ£€æŸ¥é¢‘ç‡ï¼Œå‡å°‘å¼€é”€
    timeoutSeconds: 20          # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç¬æ—¶é«˜è´Ÿè½½è¯¯åˆ¤
    failureThreshold: 12        # æ›´å®½å®¹ï¼Œ12 æ¬¡å¤±è´¥æ‰é‡å¯ï¼ˆå‡å°‘è¯¯æ€ï¼‰
    successThreshold: 1
  
  readinessProbe:
    enabled: true
    initialDelaySeconds: 20     # å¢åŠ åˆå§‹å»¶è¿Ÿï¼Œç¡®ä¿åº”ç”¨å‡†å¤‡å¥½
    periodSeconds: 10
    timeoutSeconds: 20          # å¢åŠ è¶…æ—¶æ—¶é—´
    failureThreshold: 8         # æ›´å®½å®¹ï¼Œ8 æ¬¡å¤±è´¥æ‰æ ‡è®°ä¸å¥åº·ï¼ˆå‡å°‘çŠ¶æ€é”™è¯¯ï¼‰
    successThreshold: 1         # 1 æ¬¡æˆåŠŸå³å¯æ¥å…¥æµé‡ï¼ˆåŠ å¿«æ¢å¤ï¼‰
  
  # æ»šåŠ¨æ›´æ–°ç­–ç•¥ - å¢åŠ  surge ä»¥å¿«é€Ÿå“åº”æµé‡å¢é•¿
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 3               # ä¸€æ¬¡æœ€å¤šå¢åŠ  3 ä¸ª Podï¼ˆåŸ 1ï¼‰
      maxUnavailable: 0         # ç¡®ä¿é›¶åœæœº
  
  # Pod æ‹“æ‰‘åˆ†æ•£çº¦æŸï¼šå‡åŒ€åˆ†å¸ƒï¼Œä½†å…è®¸é«˜æ€§èƒ½èŠ‚ç‚¹æ‰¿æ‹…æ›´å¤šè´Ÿè½½
  topologySpreadConstraints:
    - maxSkew: 2                  # å…è®¸æœ€å¤š 2 ä¸ª Pod çš„å·®å¼‚ï¼ˆé«˜æ€§èƒ½èŠ‚ç‚¹å¯å¤š 2 ä¸ªï¼‰
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway  # HA é›†ç¾¤ï¼Œä¿è¯å¯ç”¨æ€§ä¼˜å…ˆ
      labelSelector:
        matchLabels:
          component: api
  
  # äº²å’Œæ€§é…ç½®ï¼šä¼˜å…ˆåˆ©ç”¨é«˜æ€§èƒ½èŠ‚ç‚¹ï¼Œå‡è¡¡ä½¿ç”¨æ ‡å‡†èŠ‚ç‚¹
  affinity:
    # Pod åäº²å’Œæ€§ï¼šé€‚åº¦åˆ†æ•£ï¼Œå…è®¸é«˜å¯†åº¦éƒ¨ç½²
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 20              # ä½æƒé‡ï¼Œå…è®¸åŒèŠ‚ç‚¹å¤š Podï¼ˆHA é›†ç¾¤æ›´çµæ´»ï¼‰
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - api
            topologyKey: kubernetes.io/hostname
    
    # èŠ‚ç‚¹è°ƒåº¦ç­–ç•¥ï¼šé«˜æ€§èƒ½èŠ‚ç‚¹ä¼˜å…ˆï¼Œæ ‡å‡†èŠ‚ç‚¹å‡è¡¡
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        # æœ€é«˜ä¼˜å…ˆçº§ï¼šé«˜æ€§èƒ½èŠ‚ç‚¹ï¼ˆ32C/120Gï¼‰
        - weight: 100
          preference:
            matchExpressions:
              - key: node-type
                operator: In
                values:
                  - high-performance
        # æ¬¡ä¼˜å…ˆçº§ï¼šæ ‡å‡†èŠ‚ç‚¹ï¼ˆ16C/32Gï¼‰
        - weight: 50
          preference:
            matchExpressions:
              - key: node-type
                operator: In
                values:
                  - standard
  
  # ä¿æŒç°æœ‰ç¯å¢ƒå˜é‡é…ç½®
  logLevel: INFO  # ç”Ÿäº§ç¯å¢ƒå»ºè®® INFOï¼Œå‡å°‘æ—¥å¿—å¼€é”€ï¼ˆDEBUG ä¼šå½±å“æ€§èƒ½ï¼‰
  
  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: CHECK_UPDATE_URL
      value: ""
    - name: CODE_MAX_NUMBER
      value: "9223372036854775807"
    - name: CODE_MIN_NUMBER
      value: "-9223372036854775808"
    - name: CODE_MAX_DEPTH
      value: "10"
    - name: CODE_MAX_PRECISION
      value: "20"
    - name: CODE_MAX_STRING_LENGTH
      value: "80000"
    - name: CODE_MAX_STRING_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_OBJECT_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_NUMBER_ARRAY_LENGTH
      value: "1000"
    - name: CODE_EXECUTION_CONNECT_TIMEOUT
      value: "10"
    - name: CODE_EXECUTION_READ_TIMEOUT
      value: "360"
    - name: CODE_EXECUTION_WRITE_TIMEOUT
      value: "10"
    - name: LOG_TZ
      value: "Asia/Shanghai"
    # ä¼˜åŒ– Gunicorn é…ç½®ï¼ˆâš ï¸ è°ƒæ•´ä¸ºæ¥è¿‘1:1æ¯”ä¾‹ï¼Œè§£å†³QueuePool limit exceededé—®é¢˜ï¼‰
    - name: SERVER_WORKER_AMOUNT
      value: "2"                # æ¯ä¸ª Pod 2 ä¸ª worker
    - name: SERVER_WORKER_CLASS
      value: "gevent"           # ä½¿ç”¨ gevent å¼‚æ­¥ worker æå‡å¹¶å‘èƒ½åŠ›
    - name: SERVER_WORKER_CONNECTIONS
      value: "50"               # âš ï¸ ä»100é™åˆ°60ï¼Œå‡å°‘å¹¶å‘å‹åŠ›ï¼ˆ9Ã—2Ã—60=1080åç¨‹ï¼‰
    - name: GUNICORN_TIMEOUT
      value: "360"              # è¶…æ—¶ 6 åˆ†é’Ÿï¼ˆé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œæµï¼‰
    # æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–ï¼ˆğŸ”´ ç´§æ€¥ä¿®å¤ï¼šè¿æ¥æ•°æ‰“æ»¡ 1600/1600ï¼‰
    # é—®é¢˜ï¼šä¹‹å‰é…ç½®å¯¼è‡´è¿æ¥æ•°è¶…é™ï¼ˆ9Ã—115=1035 + Worker 180 + å…¶ä»– = 1300+ï¼‰
    # ä¿®å¤ï¼šå¤§å¹…é™ä½è¿æ¥æ± ï¼Œé˜²æ­¢è€—å°½æ•°æ®åº“è¿æ¥
    # æ–°é…ç½®ï¼š9 Pod Ã— 40 = 360ï¼ˆAPIï¼‰+ Worker 180 + å…¶ä»– 105 = 645 è¿æ¥ï¼ˆå®‰å…¨ä½™é‡ 60%ï¼‰
    - name: SQLALCHEMY_POOL_SIZE
      value: "50"               # ğŸ”´ ç´§æ€¥é™ä½ï¼ˆä» 90 â†’ 25ï¼‰
    - name: SQLALCHEMY_MAX_OVERFLOW
      value: "20"               # ä¿æŒ25ï¼ˆå³°å€¼ 115/Podï¼‰
    - name: SQLALCHEMY_POOL_RECYCLE
      value: "270"              # âš ï¸ 240ç§’å›æ”¶ï¼ˆæ•°æ®åº“è¶…æ—¶300ç§’ï¼Œç•™20%å®‰å…¨è¾¹ç•Œï¼‰
    - name: SQLALCHEMY_POOL_PRE_PING
      value: "true"             # è¿æ¥å‰æ£€æŸ¥æœ‰æ•ˆæ€§
    - name: SQLALCHEMY_POOL_TIMEOUT
      value: "120"              # ç­‰å¾…è¶…æ—¶ 120 ç§’ï¼ˆç»™äºˆæ›´å¤šå®¹é”™æ—¶é—´ï¼‰
    - name: SQLALCHEMY_ECHO
      value: "false"            # å…³é—­ SQL æ—¥å¿—
    - name: SQLALCHEMY_ECHO_POOL
      value: "false"            # å…³é—­è¿æ¥æ± æ—¥å¿—  
    - name: SQLALCHEMY_POOL_RESET_ON_RETURN
      value: "rollback"         # âš ï¸ æ ¸å¿ƒï¼šå½’è¿˜è¿æ¥æ—¶è‡ªåŠ¨å›æ»šæœªæäº¤äº‹åŠ¡
    - name: SQLALCHEMY_POOL_USE_LIFO
      value: "true"             # LIFOæ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨æœ€è¿‘çš„è¿æ¥ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
    # Redis è¿æ¥æ± ä¼˜åŒ–ï¼ˆå¢åŠ è¿æ¥æ± é¿å…è¶…æ—¶ï¼‰
    - name: REDIS_POOL_SIZE
      value: "40"               # æ¯ä¸ª Pod 40 ä¸ªè¿æ¥ï¼ˆ8-12 Pod = 320-480 è¿æ¥ï¼‰
    - name: REDIS_POOL_MAX_CONNECTIONS
      value: "60"               # æœ€å¤§ 60 ä¸ªè¿æ¥ï¼ˆå³°å€¼æ—¶ä½¿ç”¨ï¼‰
    - name: CELERY_BROKER_POOL_LIMIT
      value: "40"               # Celery broker è¿æ¥æ± ï¼ˆåŒ¹é… REDIS_POOL_SIZEï¼‰
    # æ€§èƒ½ä¼˜åŒ–é…ç½®
    - name: HTTP_REQUEST_MAX_CONNECT_TIMEOUT
      value: "30"               # HTTP è¯·æ±‚è¿æ¥è¶…æ—¶
    - name: HTTP_REQUEST_MAX_READ_TIMEOUT
      value: "60"               # HTTP è¯·æ±‚è¯»å–è¶…æ—¶
    - name: HTTP_REQUEST_MAX_WRITE_TIMEOUT
      value: "30"               # HTTP è¯·æ±‚å†™å…¥è¶…æ—¶
    - name: RETRY_TIMES
      value: "3"                # é‡è¯•æ¬¡æ•°
    - name: WEB_API_CORS_ALLOW_ORIGINS
      value: "*"                # CORS é…ç½®ï¼ˆå¦‚éœ€æ›´ä¸¥æ ¼è¯·è°ƒæ•´ï¼‰
    # ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½æå‡æ€§èƒ½
    - name: SENTRY_DSN
      value: ""                 # å…³é—­ Sentryï¼ˆå‡å°‘æ€§èƒ½å¼€é”€ï¼‰
    # è‡ªåŠ¨åˆ é™¤æ—¥å¿—
    # Enable automatic cleanup of workflow run logs to manage database size
    - name: WORKFLOW_LOG_CLEANUP_ENABLED
      value: "false"
    # Number of days to retain workflow run logs (default: 30 days)
    - name: WORKFLOW_LOG_RETENTION_DAYS
      value: "4"
    # Batch size for workflow log cleanup operations (default: 100)
    - name: WORKFLOW_LOG_CLEANUP_BATCH_SIZE
      value: "50"

###################################
# Worker æœåŠ¡ä¼˜åŒ–ï¼ˆå¼‚æ­¥ä»»åŠ¡å¤„ç† - ä¸»è¦å¤„ç†çŸ¥è¯†åº“ç´¢å¼•ï¼‰
###################################
worker:
  enabled: true
  replicas: 3                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "1000m"              # è¯·æ±‚ 1 æ ¸
      memory: "2Gi"             # è¯·æ±‚ 2G
    limits:
      cpu: "4000m"              # æœ€å¤š 4 æ ¸ï¼ˆå¤„ç†å¯†é›†çŸ¥è¯†åº“ä»»åŠ¡æ—¶ä½¿ç”¨ï¼‰
      memory: "4Gi"             # æœ€å¤š 4G
  
  autoscaling:
    enabled: true
    minReplicas: 3              # æœ€å°‘ 3 ä¸ªï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼‰
    maxReplicas: 8              # æœ€å¤š 8 ä¸ªï¼ˆå¤§é‡çŸ¥è¯†åº“ç´¢å¼•æ—¶æ‰©å®¹ï¼‰
    targetCPUUtilizationPercentage: 75    # 75% æ‰©å®¹ï¼ˆé¿å…è¿‡æ—©æ‰©å®¹æµªè´¹èµ„æºï¼‰
    targetMemoryUtilizationPercentage: 80 # 80% æ‰©å®¹
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  # æ‹“æ‰‘åˆ†æ•£çº¦æŸï¼šå‡åŒ€åˆ†å¸ƒ
  topologySpreadConstraints:
    - maxSkew: 1                  # Worker ä¿æŒå‡åŒ€åˆ†å¸ƒï¼ˆä»»åŠ¡å¤„ç†éœ€è¦è´Ÿè½½å‡è¡¡ï¼‰
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          component: worker
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 40              # é€‚åº¦åˆ†æ•£
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - worker
            topologyKey: kubernetes.io/hostname
    
    # èŠ‚ç‚¹è°ƒåº¦ç­–ç•¥ï¼šä¼˜å…ˆé«˜æ€§èƒ½èŠ‚ç‚¹ï¼ˆå¤„ç†å¼‚æ­¥ä»»åŠ¡æ›´å¿«ï¼‰
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 80              # é«˜æ€§èƒ½èŠ‚ç‚¹
          preference:
            matchExpressions:
              - key: node-type
                operator: In
                values:
                  - high-performance
        - weight: 50              # æ ‡å‡†èŠ‚ç‚¹
          preference:
            matchExpressions:
              - key: node-type
                operator: In
                values:
                  - standard
  
  logLevel: INFO
  
  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"
    # Worker æ•°æ®åº“è¿æ¥æ± ï¼ˆ3-8 Pod Ã— 60 = 180-480 è¿æ¥ï¼‰
    - name: SQLALCHEMY_POOL_SIZE
      value: "40"
    - name: SQLALCHEMY_MAX_OVERFLOW
      value: "20"
    - name: SQLALCHEMY_POOL_RECYCLE
      value: "270"              # 240ç§’å›æ”¶è¿æ¥ï¼ˆæ•°æ®åº“è¶…æ—¶300ç§’ï¼Œç•™20%å®‰å…¨è¾¹ç•Œï¼‰
    - name: SQLALCHEMY_POOL_PRE_PING
      value: "true"
    - name: SQLALCHEMY_POOL_TIMEOUT
      value: "120"
    - name: SQLALCHEMY_POOL_RESET_ON_RETURN
      value: "rollback"         # å½’è¿˜è¿æ¥æ—¶è‡ªåŠ¨å›æ»šæœªæäº¤äº‹åŠ¡
    - name: SQLALCHEMY_POOL_USE_LIFO
      value: "true"             # LIFOæ¨¡å¼
    # Celery Worker ä¼˜åŒ–ï¼ˆä½¿ç”¨æ­£ç¡®çš„ Dify ç¯å¢ƒå˜é‡åï¼‰
    - name: CELERY_AUTO_SCALE
      value: "true"             # å¯ç”¨è‡ªåŠ¨ä¼¸ç¼©
    - name: CELERY_MAX_WORKERS
      value: "4"                # æœ€å¤š 8 ä¸ªå¹¶å‘ worker
    - name: CELERY_MIN_WORKERS
      value: "2"                # æœ€å°‘ 2 ä¸ªå¹¶å‘ worker
    - name: CELERY_WORKER_CLASS
      value: "gevent"           # ä½¿ç”¨ gevent worker
    - name: MAX_TASK_PRE_CHILD
      value: "100"              # æ¯ä¸ª worker å¤„ç† 100 ä¸ªä»»åŠ¡åé‡å¯ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    # è‡ªåŠ¨åˆ é™¤æ—¥å¿—
    # Enable automatic cleanup of workflow run logs to manage database size
    - name: WORKFLOW_LOG_CLEANUP_ENABLED
      value: "false"
    # Number of days to retain workflow run logs (default: 30 days)
    - name: WORKFLOW_LOG_RETENTION_DAYS
      value: "4"
    # Batch size for workflow log cleanup operations (default: 100)
    - name: WORKFLOW_LOG_CLEANUP_BATCH_SIZE
      value: "50"
    
    - name: CODE_MAX_NUMBER
      value: "9223372036854775807"
    - name: CODE_MIN_NUMBER
      value: "-9223372036854775808"
    - name: CODE_MAX_DEPTH
      value: "10"
    - name: CODE_MAX_PRECISION
      value: "20"
    - name: CODE_MAX_STRING_LENGTH
      value: "80000"
    - name: CODE_MAX_STRING_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_OBJECT_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_NUMBER_ARRAY_LENGTH
      value: "1000"
    - name: CODE_EXECUTION_CONNECT_TIMEOUT
      value: "10"
    - name: CODE_EXECUTION_READ_TIMEOUT
      value: "360"
    - name: CODE_EXECUTION_WRITE_TIMEOUT
      value: "10"

###################################
# Beat æœåŠ¡ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼‰
###################################
beat:
  enabled: true
  # Beat åªéœ€è¦ 1 ä¸ªå‰¯æœ¬ï¼ˆå¤šä¸ªä¼šé‡å¤æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼‰
  
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  updateStrategy:
    type: Recreate             # Beat ä½¿ç”¨ Recreate ç­–ç•¥ï¼ˆé¿å…å¤šå®ä¾‹ï¼‰
  
  logLevel: INFO
  
  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"
    # Beat æ•°æ®åº“è¿æ¥æ± ï¼ˆ1 Podï¼Œ10+5=15 å³°å€¼ï¼‰
    - name: SQLALCHEMY_POOL_SIZE
      value: "10"
    - name: SQLALCHEMY_MAX_OVERFLOW
      value: "5"
    - name: SQLALCHEMY_POOL_RECYCLE
      value: "270"              # 240ç§’å›æ”¶è¿æ¥ï¼ˆæ•°æ®åº“è¶…æ—¶300ç§’ï¼‰
    - name: SQLALCHEMY_POOL_PRE_PING
      value: "true"
    - name: SQLALCHEMY_POOL_TIMEOUT
      value: "120"
    - name: SQLALCHEMY_POOL_RESET_ON_RETURN
      value: "rollback"
    - name: SQLALCHEMY_POOL_USE_LIFO
      value: "true"
    # è‡ªåŠ¨åˆ é™¤æ—¥å¿—
    # Enable automatic cleanup of workflow run logs to manage database size
    - name: WORKFLOW_LOG_CLEANUP_ENABLED
      value: "false"
    # Number of days to retain workflow run logs (default: 30 days)
    - name: WORKFLOW_LOG_RETENTION_DAYS
      value: "4"
    # Batch size for workflow log cleanup operations (default: 100)
    - name: WORKFLOW_LOG_CLEANUP_BATCH_SIZE
      value: "50"
    - name: CODE_MAX_NUMBER
      value: "9223372036854775807"
    - name: CODE_MIN_NUMBER
      value: "-9223372036854775808"
    - name: CODE_MAX_DEPTH
      value: "10"
    - name: CODE_MAX_PRECISION
      value: "20"
    - name: CODE_MAX_STRING_LENGTH
      value: "80000"
    - name: CODE_MAX_STRING_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_OBJECT_ARRAY_LENGTH
      value: "70"
    - name: CODE_MAX_NUMBER_ARRAY_LENGTH
      value: "1000"
    - name: CODE_EXECUTION_CONNECT_TIMEOUT
      value: "10"
    - name: CODE_EXECUTION_READ_TIMEOUT
      value: "360"
    - name: CODE_EXECUTION_WRITE_TIMEOUT
      value: "10"

###################################
# Web å‰ç«¯æœåŠ¡ä¼˜åŒ–
###################################
web:
  enabled: true
  replicas: 3                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  
  autoscaling:
    enabled: true
    minReplicas: 3              # æœ€å°‘ 3 ä¸ªï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼‰
    maxReplicas: 6              # æœ€å¤š 6 ä¸ªï¼ˆæ‰©å®¹æ—¶æ¯èŠ‚ç‚¹2ä¸ªï¼‰
    targetCPUUtilizationPercentage: 70
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - web
            topologyKey: kubernetes.io/hostname

###################################
# Sandbox æœåŠ¡ä¼˜åŒ–ï¼ˆä»£ç æ‰§è¡Œï¼‰
###################################
sandbox:
  enabled: true
  replicas: 5                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "2000m"
      memory: "2Gi"
    limits:
      cpu: "4000m"
      memory: "4Gi"
  
  autoscaling:
    enabled: true
    minReplicas: 5              # æœ€å°‘ 3 ä¸ªï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼‰
    maxReplicas: 8              # æœ€å¤š 6 ä¸ªï¼ˆæ‰©å®¹æ—¶æ¯èŠ‚ç‚¹2ä¸ªï¼‰
    targetCPUUtilizationPercentage: 60
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - sandbox
            topologyKey: kubernetes.io/hostname
  
  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: WORKER_TIMEOUT
      value: "15"
    - name: PIP_MIRROR_URL
      value: "https://mirrors.aliyun.com/pypi/simple/"

###################################
# Proxy æœåŠ¡ä¼˜åŒ–
###################################
proxy:
  enabled: true
  replicas: 3                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "500m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "512Mi"
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - proxy
            topologyKey: kubernetes.io/hostname
  
  # Nginx ä¼˜åŒ–é…ç½®
  clientMaxBodySize: "100m"     # å¢åŠ ä¸Šä¼ å¤§å°é™åˆ¶

  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"

###################################
# SSRF Proxy æœåŠ¡
###################################
ssrfProxy:
  enabled: true
  replicas: 3                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"           # æé«˜åˆ° 1Gi
    limits:
      cpu: "1000m"              # æé«˜åˆ° 1 æ ¸ï¼ˆåŸ500mï¼‰
      memory: "2Gi"             # æé«˜åˆ° 2Gi é¿å…OOMKilled
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"

###################################
# Plugin Daemon æœåŠ¡
###################################
pluginDaemon:
  enabled: true
  replicas: 3                   # 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼Œæé«˜å¯ç”¨æ€§ï¼‰
  
  resources:
    requests:
      cpu: "2000m"
      memory: "8Gi"
    limits:
      cpu: "6000m"
      memory: "12Gi"
  
  # âš ï¸ å»¶è¿Ÿæ¥å…¥æµé‡é…ç½®ï¼šä½¿ç”¨ tcpSocket æ£€æŸ¥ç«¯å£ç›‘å¬
  # ç”±äº plugin-daemon æ²¡æœ‰ /health ç«¯ç‚¹ï¼Œä½¿ç”¨ tcpSocket æ£€æŸ¥ 5002 ç«¯å£æ˜¯å¦ç›‘å¬
  # initialDelaySeconds: 180 ç§’ï¼ˆ3 åˆ†é’Ÿï¼‰æ˜¯æ’ä»¶ç¼–è¯‘çš„åˆç†ç­‰å¾…æ—¶é—´
  # é…åˆè¾ƒé«˜çš„ failureThresholdï¼Œå³ä½¿ç¼–è¯‘æ—¶é—´è¾ƒé•¿ä¹Ÿèƒ½å®¹é”™
  customReadinessProbe:
    tcpSocket:
      port: 5002
    initialDelaySeconds: 240    # 4 åˆ†é’Ÿåå¼€å§‹æ£€æŸ¥ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§ï¼‰
    periodSeconds: 10           # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
    timeoutSeconds: 5           # 5 ç§’è¶…æ—¶
    failureThreshold: 30        # âš ï¸ å…è®¸ 30 æ¬¡å¤±è´¥ï¼ˆ30Ã—10ç§’=5åˆ†é’Ÿé¢å¤–å®¹é”™æ—¶é—´ï¼‰
    successThreshold: 1         # 1 æ¬¡æˆåŠŸå³æ ‡è®°ä¸ºå°±ç»ª
  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - plugin-daemon
            topologyKey: kubernetes.io/hostname
  
  extraEnv:
    - name: TZ
      value: "Asia/Shanghai"
    - name: LOG_TZ
      value: "Asia/Shanghai"
    - name: PIP_MIRROR_URL
      value: "https://mirrors.aliyun.com/pypi/simple/"
    # PluginDaemon æ•°æ®åº“è¿æ¥æ± ï¼ˆ3 Podï¼Œæ¯ Pod 20+10=30 å³°å€¼ = 90 è¿æ¥ï¼‰
    - name: SQLALCHEMY_POOL_SIZE
      value: "20"
    - name: SQLALCHEMY_MAX_OVERFLOW
      value: "10"
    - name: SQLALCHEMY_POOL_RECYCLE
      value: "270"              # 240ç§’å›æ”¶è¿æ¥ï¼ˆæ•°æ®åº“è¶…æ—¶300ç§’ï¼‰
    - name: SQLALCHEMY_POOL_PRE_PING
      value: "true"
    - name: SQLALCHEMY_POOL_TIMEOUT
      value: "120"              # å¢åŠ è¶…æ—¶æ—¶é—´
    - name: SQLALCHEMY_POOL_RESET_ON_RETURN
      value: "rollback"
    - name: SQLALCHEMY_POOL_USE_LIFO
      value: "true"
    # è‡ªåŠ¨åˆ é™¤æ—¥å¿—
    # Enable automatic cleanup of workflow run logs to manage database size
    - name: WORKFLOW_LOG_CLEANUP_ENABLED
      value: "false"
    # Number of days to retain workflow run logs (default: 30 days)
    - name: WORKFLOW_LOG_RETENTION_DAYS
      value: "4"
    # Batch size for workflow log cleanup operations (default: 100)
    - name: WORKFLOW_LOG_CLEANUP_BATCH_SIZE
      value: "50"

###################################
# Service é…ç½®
# æ³¨æ„ï¼šIngress é…ç½®ç»§æ‰¿è‡ª values-dify.yamlï¼Œä¸åœ¨æ­¤è¦†ç›–
###################################
service:
  type: ClusterIP
  port: 80

###################################
# å…¨å±€èµ„æºé…ç½®
###################################
# æ³¨æ„ï¼šè¿™é‡Œçš„ resources æ˜¯ç¤ºä¾‹ï¼Œå®é™…æ¯ä¸ªç»„ä»¶å·²ç»å•ç‹¬é…ç½®
resources: {}

###################################
# å…¨å±€èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆå¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰
###################################
nodeSelector: {}

###################################
# å…¨å±€å®¹å¿åº¦
###################################
tolerations: []

###################################
# å…¨å±€äº²å’Œæ€§
###################################
affinity: {}

# ==============================================================================
# è¯´æ˜ï¼š
# 1. API æœåŠ¡æ˜¯ç“¶é¢ˆï¼Œé…ç½®äº† 8 ä¸ªåŸºç¡€å‰¯æœ¬ï¼ŒHPA 8-12 å‰¯æœ¬è‡ªåŠ¨ä¼¸ç¼©
# 2. Worker é…ç½®äº† 3 ä¸ªåŸºç¡€å‰¯æœ¬ï¼ŒHPA 3-8 å‰¯æœ¬ï¼ˆé—²æ—¶èŠ‚çœèµ„æºç»™APIï¼‰
# 3. å…¶ä»–æœåŠ¡ï¼ˆWeb/Sandbox/Proxyç­‰ï¼‰å„ 3 ä¸ªå‰¯æœ¬ï¼ˆ3èŠ‚ç‚¹HAï¼Œæ¯èŠ‚ç‚¹1ä¸ªï¼‰
# 4. ä½¿ç”¨ Pod åäº²å’Œæ€§å°†å‰¯æœ¬åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼Œä¿è¯é«˜å¯ç”¨
# 5. API/Worker ä¼˜å…ˆè°ƒåº¦åˆ°é«˜æ€§èƒ½èŠ‚ç‚¹ï¼ˆ32C/120Gï¼‰ï¼Œå…¶ä»–æœåŠ¡å‡è¡¡åˆ†å¸ƒ
# 6. ç”Ÿäº§ç¯å¢ƒå»ºè®®ç›‘æ§æŒ‡æ ‡ï¼š
#    - API Pod CPU/Memory ä½¿ç”¨ç‡ï¼ˆç›®æ ‡ <70%ï¼‰
#    - HPA ä¼¸ç¼©äº‹ä»¶ï¼ˆè§‚å¯Ÿæ‰©ç¼©å®¹é¢‘ç‡ï¼‰
#    - P99 å“åº”æ—¶é—´ï¼ˆç›®æ ‡ <1sï¼‰
#    - é”™è¯¯ç‡ï¼ˆç›®æ ‡ <0.5%ï¼‰
#    - PostgreSQL è¿æ¥æ•°ï¼ˆç›®æ ‡ <1000ï¼Œä¿å®ˆé…ç½®å³°å€¼è§ä¸‹ï¼‰
# 7. æ•°æ®åº“è¿æ¥æ•°è®¡ç®—ï¼ˆä¿å®ˆé…ç½® - å³°å€¼ï¼‰ï¼š
#    - API: 8-12 Pod Ã— 45 = 360-540 è¿æ¥
#    - Worker: 3-8 Pod Ã— 60 = 180-480 è¿æ¥
#    - PluginDaemon: 3 Pod Ã— 30 = 90 è¿æ¥
#    - Beat: 1 Pod Ã— 15 = 15 è¿æ¥
#    - æ€»è®¡å³°å€¼ï¼š645-1125 è¿æ¥
#    - é˜¿é‡Œäº‘ä¸Šé™ï¼š1600 è¿æ¥
#    - å®‰å…¨ä½™é‡ï¼š475-955 è¿æ¥ï¼ˆ30%-60%ç¼“å†²ï¼‰âœ… ä¿å®ˆå®‰å…¨
# 8. å¹¶å‘æ§åˆ¶ç­–ç•¥ï¼ˆä¿å®ˆé…ç½®ï¼‰ï¼š
#    - API çº¿ç¨‹æ•°é™ä½åˆ° 25ï¼ˆvs 45è¿æ¥æ±  = 44%ä½™é‡ï¼‰
#    - å•Podè¿æ¥æ±  vs çº¿ç¨‹æ•°ï¼š45è¿æ¥ vs 25çº¿ç¨‹ = 20ä¸ªç¼“å†²
#    - ç¡®ä¿å³ä½¿é«˜å¹¶å‘æ—¶ä¹Ÿä¸ä¼šè€—å°½è¿æ¥æ± 
#    - ç‰ºç‰²éƒ¨åˆ†å¹¶å‘æ€§èƒ½æ¢å–ç³»ç»Ÿç¨³å®šæ€§
# 9. æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼š
#    - PluginDaemon: æ–°Podç­‰å¾…5åˆ†é’Ÿåæ‰æ¥å…¥æµé‡ï¼ˆç­‰å¾…ç¼–è¯‘å®Œæˆï¼‰
#    - API: æ–°Podç­‰å¾…20ç§’åæ¥å…¥æµé‡
#    - maxUnavailable: 0 ç¡®ä¿é›¶åœæœºéƒ¨ç½²
# 
# ä½¿ç”¨æ–¹å¼ï¼š
# helm upgrade dify charts/dify -f values-dify.yaml -f values-secrets.yaml -f values-dify-prod.yaml -n dify
# ==============================================================================
# 
# æ³¨æ„ï¼šé‚®ä»¶é…ç½®è¯·åœ¨ values-secrets.yaml ä¸­é…ç½®ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰

