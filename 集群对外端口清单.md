# 集群对外端口清单

生成时间：2025-11-07  
集群环境：3节点 K3s 集群（192.168.44.231, 192.168.44.234, 192.168.44.235）

---

## 📋 目录
- [一、主服务端口（必须保留）](#一主服务端口必须保留)
- [二、监控管理端口（必须保留）](#二监控管理端口必须保留)
- [三、数据库服务端口（本地Docker容器）](#三数据库服务端口本地docker容器)
- [四、Kubernetes系统端口](#四kubernetes系统端口)
- [五、端口汇总表](#五端口汇总表)
- [六、安全加固建议](#六安全加固建议)

---

## 一、主服务端口（必须保留）

### 1. Ingress 控制器 - Nginx Ingress
**服务名称**: `ingress-nginx-controller`  
**类型**: LoadBalancer  
**命名空间**: `ingress-nginx`

| 端口 | 协议 | 用途 | 外部IP | NodePort | 说明 |
|-----|------|------|--------|----------|------|
| **80** | TCP | HTTP流量 | 192.168.44.231<br>192.168.44.234<br>192.168.44.235 | 31519 | **主要入口**：Dify应用HTTP访问<br>域名访问通过此端口 |
| **443** | TCP | HTTPS流量 | 192.168.44.231<br>192.168.44.234<br>192.168.44.235 | 32443 | HTTPS加密访问（如已配置TLS） |

**用途说明**：
- 这是**整个集群的主要入口**，所有外部HTTP/HTTPS请求都通过这里进入
- Dify 应用（dify.wsljf.xyz）通过此Ingress暴露
- **必须保留**，关闭将导致所有Web服务无法访问

---

## 二、监控管理端口（必须保留）

### 1. Kubernetes Dashboard
**服务名称**: `kubernetes-dashboard-kong-proxy`  
**类型**: NodePort  
**命名空间**: `kubernetes-dashboard`

| 端口 | 协议 | 用途 | 访问方式 | 说明 |
|-----|------|------|---------|------|
| **30718** | TCP | Dashboard Web界面 | `https://<任意节点IP>:30718` | K8s集群管理面板<br>**必须保留** |

**访问示例**：
```
https://192.168.44.231:30718
https://192.168.44.234:30718
https://192.168.44.235:30718
```

**用途说明**：
- 用于可视化管理 Kubernetes 集群
- 查看 Pod、Service、Deployment 等资源状态
- **建议保留**：运维管理必备工具

---

### 2. Grafana（日志可视化）
**服务名称**: `grafana`  
**类型**: NodePort  
**命名空间**: `loki`

| 端口 | 协议 | 用途 | 访问方式 | 说明 |
|-----|------|------|---------|------|
| **30300** | TCP | Grafana Web界面 | `http://<任意节点IP>:30300` | 日志查询和可视化<br>**建议保留** |

**访问示例**：
```
http://192.168.44.231:30300
http://192.168.44.234:30300
http://192.168.44.235:30300
```

**用途说明**：
- 查询和可视化应用日志
- 监控集群性能指标
- **建议保留**：故障排查和性能分析必备

---

### 3. Loki（日志收集API）
**服务名称**: `loki-external`  
**类型**: NodePort  
**命名空间**: `loki`

| 端口 | 协议 | 用途 | 访问方式 | 说明 |
|-----|------|------|---------|------|
| **30100** | TCP | Loki API | `http://<任意节点IP>:30100` | 日志收集和查询API<br>**必须保留** |

**用途说明**：
- Grafana 后端日志数据源
- 应用日志收集端点
- **必须保留**：与 Grafana 配套使用

---

## 三、数据库服务端口（本地Docker容器）

> ⚠️ **重要提示**：以下服务运行在主节点（192.168.44.231）的Docker容器中

### 1. Milvus 向量数据库
**容器名称**: `dify-milvus`  
**运行位置**: 主节点 Docker

| 端口 | 协议 | 用途 | 访问方式 | 说明 |
|-----|------|------|---------|------|
| **19530** | TCP | Milvus gRPC API | `192.168.44.231:19530` | 向量数据库API<br>**必须保留** |
| **9091** | TCP | Milvus Web UI | `http://192.168.44.231:9091` | Milvus管理界面<br>**可选** |

**用途说明**：
- Dify 知识库向量存储
- 文档嵌入搜索和检索
- **必须保留**：Dify核心功能依赖

---

### 2. MinIO（Milvus内部存储）
**容器名称**: `dify-milvus-minio`  
**运行位置**: 主节点 Docker

| 端口 | 协议 | 用途 | 说明 |
|-----|------|------|------|
| 9000 | TCP | MinIO API | **未对外暴露**（仅容器内部） |

**用途说明**：
- Milvus 内部对象存储
- 无需外部访问

---

### 3. etcd（Milvus元数据）
**容器名称**: `dify-milvus-etcd`  
**运行位置**: 主节点 Docker

| 端口 | 协议 | 用途 | 说明 |
|-----|------|------|------|
| 2379-2380 | TCP | etcd集群通信 | **未对外暴露**（仅容器内部） |

**用途说明**：
- Milvus 元数据存储
- 无需外部访问

---

## 四、Kubernetes系统端口

> ⚠️ **安全提示**：以下端口用于Kubernetes内部通信，**不应对外网开放**

### 1. K3s API Server
| 端口 | 用途 | 访问限制 |
|-----|------|---------|
| **6443** | Kubernetes API | 仅内网访问（kubectl、Dashboard使用） |

### 2. kubelet
| 端口 | 用途 | 访问限制 |
|-----|------|---------|
| **10250** | kubelet API | 仅集群内部 |

### 3. etcd（K3s集群）
| 端口 | 用途 | 访问限制 |
|-----|------|---------|
| **2379** | etcd客户端通信 | 仅集群内部 |
| **2380** | etcd节点间通信 | 仅集群内部 |

### 4. 其他系统端口
| 端口 | 用途 | 访问限制 |
|-----|------|---------|
| 53 | CoreDNS | 仅集群内部 |
| 10248-10259 | K8s组件健康检查 | 仅本地访问 |

---

## 五、端口汇总表

### ✅ **必须对外开放的端口（核心服务）**

| 端口 | 服务 | 协议 | 节点 | 用途 | 优先级 |
|-----|------|------|------|------|--------|
| **80** | Ingress HTTP | TCP | 231/234/235 | Dify应用主要入口 | 🔴 最高 |
| **443** | Ingress HTTPS | TCP | 231/234/235 | HTTPS加密访问 | 🔴 最高 |
| **19530** | Milvus | TCP | 231 | 向量数据库 | 🔴 最高 |
| **30100** | Loki API | TCP | 231/234/235 | 日志收集 | 🟠 高 |

### ⚙️ **建议保留的端口（管理/监控）**

| 端口 | 服务 | 协议 | 节点 | 用途 | 优先级 |
|-----|------|------|------|------|--------|
| **30718** | Dashboard | TCP | 231/234/235 | K8s集群管理 | 🟡 中 |
| **30300** | Grafana | TCP | 231/234/235 | 日志可视化 | 🟡 中 |
| **9091** | Milvus UI | TCP | 231 | 向量库管理 | 🟢 低 |

### ⛔ **不应对外网开放的端口（安全风险）**

| 端口范围 | 服务 | 说明 |
|---------|------|------|
| 6443 | K8s API | 仅允许运维内网访问 |
| 10250 | kubelet | 仅集群内部 |
| 2379-2380 | etcd | 仅集群内部 |
| 22 | SSH | 仅运维堡垒机访问 |

---

## 六、安全加固建议

### 🔒 防火墙配置示例（iptables）

#### 1. 开放必须端口（所有节点）
```bash
# 允许 Ingress 入口（HTTP/HTTPS）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许 Loki API（日志收集）
iptables -A INPUT -p tcp --dport 30100 -j ACCEPT

# 允许 Dashboard（限制来源IP）
iptables -A INPUT -p tcp --dport 30718 -s <运维网段> -j ACCEPT

# 允许 Grafana（限制来源IP）
iptables -A INPUT -p tcp --dport 30300 -s <运维网段> -j ACCEPT
```

#### 2. 开放 Milvus 端口（仅主节点 192.168.44.231）
```bash
# 允许 Milvus 向量库
iptables -A INPUT -p tcp --dport 19530 -j ACCEPT

# Milvus Web UI（可选，建议限制来源IP）
iptables -A INPUT -p tcp --dport 9091 -s <运维网段> -j ACCEPT
```

#### 3. 限制内部通信端口（所有节点）
```bash
# K8s API Server - 仅允许内网
iptables -A INPUT -p tcp --dport 6443 -s 192.168.44.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 6443 -j DROP

# etcd - 仅允许集群节点
iptables -A INPUT -p tcp --dport 2379:2380 -s 192.168.44.231 -j ACCEPT
iptables -A INPUT -p tcp --dport 2379:2380 -s 192.168.44.234 -j ACCEPT
iptables -A INPUT -p tcp --dport 2379:2380 -s 192.168.44.235 -j ACCEPT
iptables -A INPUT -p tcp --dport 2379:2380 -j DROP

# kubelet - 仅允许集群内部
iptables -A INPUT -p tcp --dport 10250 -s 192.168.44.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 10250 -j DROP
```

---

### 🛡️ 安全检查清单

- [ ] **关闭不必要的端口**：定期扫描开放端口（`nmap -p- <节点IP>`）
- [ ] **限制管理端口访问**：Dashboard/Grafana 限制为运维IP段
- [ ] **配置TLS证书**：Ingress 启用HTTPS（端口443）
- [ ] **启用Ingress认证**：为敏感服务配置 Basic Auth 或 OAuth
- [ ] **监控异常流量**：配置 Grafana 告警规则
- [ ] **定期更新系统**：及时修补安全漏洞

---

### 📞 联系信息

- **报告生成**: Cursor AI Assistant
- **生成时间**: 2025-11-07
- **集群版本**: K3s v1.33.5
- **Dify版本**: 基于 Helm Chart 部署

---

## 附录：快速验证命令

### 检查所有对外服务
```bash
kubectl get svc -A | grep -E "(LoadBalancer|NodePort)"
```

### 检查Ingress规则
```bash
kubectl get ingress -A
```

### 扫描节点开放端口
```bash
# 扫描主节点
nmap -p- 192.168.44.231

# 扫描所有节点
for ip in 231 234 235; do
  echo "=== 192.168.44.$ip ==="
  nmap -p 80,443,6443,19530,30100,30300,30718 192.168.44.$ip
done
```

### 检查Docker容器端口
```bash
docker ps --format "table {{.Names}}\t{{.Ports}}"
```

---

**文档结束**





